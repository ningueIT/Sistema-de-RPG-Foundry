{{!-- Layout se HP > 0: 3 colunas (topo: Defesa/CD/Movimento; base: Iniciativa / Dados Vida / Dados Energia) --}}
{{#if system.recursos.hp.value}}
<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
    <div style="grid-column: 1 / -1; text-align: right; margin-bottom: 6px; display:flex; gap:8px; justify-content:flex-end;">
        <!-- Botões de Descanso removidos: usar macros -->
    </div>

    <div class="combat-card flexcol flex-group-center" style="grid-column: span 1;">
        <label>DEFESA</label>
        <input type="number" name="system.combate.defesa.value" value="{{system.combate.defesa.value}}"/>
    </div>

    <div class="combat-card flexcol flex-group-center" style="grid-column: span 1;">
        <label>CD</label>
        <input type="number" name="system.combate.cd.value" value="{{system.combate.cd.value}}"/>
    </div>

    <div class="combat-card flexcol flex-group-center" style="grid-column: span 1;">
        <label>MOVIMENTO</label>
        <div style="display: flex; align-items: center; justify-content: center; gap: 2px;">
            <input type="number" name="system.combate.movimento.value" value="{{system.combate.movimento.value}}"/>
            <span style="font-size: 10px; color: #888;">m</span>
        </div>
    </div>

    <div class="combat-card flexcol flex-group-center" style="grid-column: span 1;">
        <label class="roll-initiative rollable" style="cursor: pointer; color: #9b4dca;">
            <i class="fas fa-dice-d20"></i> INICIATIVA
        </label>
        <input type="number" name="system.combate.iniciativa.value" value="{{system.combate.iniciativa.value}}" placeholder="+0"/>
    </div>

    <div class="combat-card flexcol flex-group-center" style="grid-column: span 1;">
        <label class="roll-dice rollable" data-formula="{{system.combate.dadosVida.lado}}" data-flavor="Dados de Vida">
            <i class="fas fa-dice"></i> DADOS VIDA
        </label>
        <input type="text" name="system.combate.dadosVida.lado" value="{{system.combate.dadosVida.lado}}" style="font-size: 12px; height: 20px; margin-bottom: 3px; text-align:center;" placeholder="Ex: 1d8"/>
        <div class="status-inputs flexrow" style="gap: 2px;">
            <input type="number" value="{{system.combate.dadosVida.value}}" style="font-size: 14px; height: 25px;" readonly disabled/>
            <span style="color:#888;">/</span>
            <input type="number" value="{{system.combate.dadosVida.max}}" style="font-size: 14px; height: 25px;" readonly disabled/>
        </div>
    </div>

    <div class="combat-card flexcol flex-group-center" style="grid-column: span 1;">
        <label class="roll-dice rollable" data-formula="{{system.combate.dadosEnergia.lado}}" data-flavor="Dados de Energia">
            <i class="fas fa-dice"></i> DADOS ENERGIA
        </label>
        <input type="text" name="system.combate.dadosEnergia.lado" value="{{system.combate.dadosEnergia.lado}}" style="font-size: 12px; height: 20px; margin-bottom: 3px; text-align:center;" placeholder="Ex: 1d6"/>
        <div class="status-inputs flexrow" style="gap: 2px;">
            <input type="number" value="{{system.combate.dadosEnergia.value}}" style="font-size: 14px; height: 25px;" readonly disabled/>
            <span style="color:#888;">/</span>
            <input type="number" value="{{system.combate.dadosEnergia.max}}" style="font-size: 14px; height: 25px;" readonly disabled/>
        </div>
    </div>
</div>
{{else}}
{{!-- HP == 0: layout com 4 colunas no topo; death saves ocupam 2 colunas na linha de baixo --}}
<div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
    <div style="grid-column: 1 / -1; text-align: right; margin-bottom: 6px; display:flex; gap:8px; justify-content:flex-end;">
        <!-- Botões de Descanso removidos: usar macros -->
    </div>

    <div class="combat-card flexcol flex-group-center" style="grid-column: span 1;">
        <label>DEFESA</label>
        <input type="number" name="system.combate.defesa.value" value="{{system.combate.defesa.value}}"/>
    </div>

    <div class="combat-card flexcol flex-group-center" style="grid-column: span 1;">
        <label>CD</label>
        <input type="number" name="system.combate.cd.value" value="{{system.combate.cd.value}}"/>
    </div>

    <div class="combat-card flexcol flex-group-center" style="grid-column: span 1;">
        <label>MOVIMENTO</label>
        <div style="display: flex; align-items: center; justify-content: center; gap: 2px;">
            <input type="number" name="system.combate.movimento.value" value="{{system.combate.movimento.value}}"/>
            <span style="font-size: 10px; color: #888;">m</span>
        </div>
    </div>

    <div class="combat-card flexcol flex-group-center" style="grid-column: span 1;">
        <label class="roll-initiative rollable" style="cursor: pointer; color: #9b4dca;">
            <i class="fas fa-dice-d20"></i> INICIATIVA
        </label>
        <input type="number" name="system.combate.iniciativa.value" value="{{system.combate.iniciativa.value}}" placeholder="+0"/>
    </div>

    {{!-- Linha de baixo: Testes de Morte (ocupando 2 colunas), Dados Vida e Dados Energia --}}
    <div class="combat-card death-saves flexcol flex-group-center" style="grid-column: 1 / span 2; margin-top: 5px;">
        <label style="width:100%; text-align:center; border-bottom: 1px solid #444; margin-bottom: 8px;">TESTES DE MORTE</label>
        <div style="width:100%; display:flex; justify-content:center; gap:12px; align-items:center; margin-bottom:6px;">
            <div style="text-align:center;">
                <div class="death-row-label" style="font-size:11px; color:#4caf50;">Sucesso</div>
                <div class="death-pills" data-type="success">
                    <div class="death-pill {{#if system.combate.morte.s1}}active{{/if}}" data-path="system.combate.morte.s1" data-index="1"></div>
                    <div class="death-pill {{#if system.combate.morte.s2}}active{{/if}}" data-path="system.combate.morte.s2" data-index="2"></div>
                    <div class="death-pill {{#if system.combate.morte.s3}}active{{/if}}" data-path="system.combate.morte.s3" data-index="3"></div>
                </div>
            </div>
            <div style="text-align:center;">
                <div class="death-row-label" style="font-size:11px; color:#ff5252;">Falha</div>
                <div class="death-pills" data-type="fail">
                    <div class="death-pill {{#if system.combate.morte.f1}}active fail{{/if}}" data-path="system.combate.morte.f1" data-index="1"></div>
                    <div class="death-pill {{#if system.combate.morte.f2}}active fail{{/if}}" data-path="system.combate.morte.f2" data-index="2"></div>
                    <div class="death-pill {{#if system.combate.morte.f3}}active fail{{/if}}" data-path="system.combate.morte.f3" data-index="3"></div>
                </div>
            </div>
            <div style="display:flex; flex-direction:row; gap:8px; align-items:center;">
                <button class="death-test-btn" type="button" title="Fazer um teste de morte">Testar</button>
                <button class="death-reset-btn" type="button" title="Resetar testes">Resetar</button>
            </div>
        </div>
    </div>

    <div class="combat-card flexcol flex-group-center" style="grid-column: span 1; margin-top: 5px;">
        <label class="roll-dice rollable" data-formula="{{system.combate.dadosVida.lado}}" data-flavor="Dados de Vida">
            <i class="fas fa-dice"></i> DADOS VIDA
        </label>
        <input type="text" name="system.combate.dadosVida.lado" value="{{system.combate.dadosVida.lado}}" style="font-size: 12px; height: 20px; margin-bottom: 3px; text-align:center;" placeholder="Ex: 1d8"/>
        <div class="status-inputs flexrow" style="gap: 2px;">
            <input type="number" value="{{system.combate.dadosVida.value}}" style="font-size: 14px; height: 25px;" readonly disabled/>
            <span style="color:#888;">/</span>
            <input type="number" value="{{system.combate.dadosVida.max}}" style="font-size: 14px; height: 25px;" readonly disabled/>
        </div>
    </div>

    <div class="combat-card flexcol flex-group-center" style="grid-column: span 1; margin-top: 5px;">
        <label class="roll-dice rollable" data-formula="{{system.combate.dadosEnergia.lado}}" data-flavor="Dados de Energia">
            <i class="fas fa-dice"></i> DADOS ENERGIA
        </label>
        <input type="text" name="system.combate.dadosEnergia.lado" value="{{system.combate.dadosEnergia.lado}}" style="font-size: 12px; height: 20px; margin-bottom: 3px; text-align:center;" placeholder="Ex: 1d6"/>
        <div class="status-inputs flexrow" style="gap: 2px;">
            <input type="number" value="{{system.combate.dadosEnergia.value}}" style="font-size: 14px; height: 25px;" readonly disabled/>
            <span style="color:#888;">/</span>
            <input type="number" value="{{system.combate.dadosEnergia.max}}" style="font-size: 14px; height: 25px;" readonly disabled/>
        </div>
    </div>
</div>
{{/if}}